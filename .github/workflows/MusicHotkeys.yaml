name: Build Windows Executable

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller pystray pillow keyboard pyautogui flet

    - name: Create config.txt if not exists (для тестирования)
      run: |
        if (-not (Test-Path config.txt)) {
            Write-Output "Creating default config.txt for testing"
            Set-Content -Path config.txt -Value "# Default configuration`nhotkey1=ctrl+alt+1`nhotkey2=ctrl+alt+2"
        }

    - name: Verify resources exist
      run: |
        Write-Output "Checking required files:"
        Get-ChildItem -Recurse -File | ForEach-Object { Write-Output "  - $($_.Name)" }
        if (-not (Test-Path config.txt)) { Write-Output "❌ config.txt not found!"; exit 1 }
        if (-not (Test-Path flet_resources)) { Write-Output "❌ flet_resources folder not found!"; exit 1 }

    - name: Build final version (without console)
      run: |
        pyinstaller MusicHotkeys_temp.spec --clean --noconfirm
        Remove-Item MusicHotkeys_temp.spec

    - name: Upload executable artifact
      uses: actions/upload-artifact@v4
      with:
        name: MusicHotkeys-Executable
        path: dist/MusicHotkeys.exe
        if-no-files-found: error